<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        
    </head>
        <body>
            <div id="create-update"style="display:none">
                <h2>Create Update</h2>
                <table id="createUpdateForm">
                    <tr>
                        <td>personid</td>
                        <td><input type="text" name="personid" id="idInput"></td>    
                    </tr>
                    <tr>
                        <td>personname</td>
                        <td><input type="text" name="personname"></td>    
                    </tr>
                    <tr>        
                        <td>age</td>
                        <td><input type="number" name="age"></td>   
                    </td>
                    <tr>
                        <td>
                            <button id="create-button" onclick ="doCreate()">Create</button>
                        </td>
                        <td>
                            <button id="update-button" onclick ="doUpdate()">update</button>
                        </td>
                    </tr>
                </table>
            </div>
            <div id="display">
                <h2>Person</h2>
                <button onClick="showCreate()">Create</button>
                <table id="personTable" class="table">
                    <tr>
                        <th>PersonID</th>
                        <th>PersonName</th>
                        <th>Age</th>
                        <th></th>
                        <th></th>
                    </tr>
                </table>

            </div>
            <script>
                function showCreate(){
                    document.getElementById('display').style.display = "none"
                    document.getElementById('update-button').style.display = "none"
                    document.getElementById('create-button').style.display = "block"
                    document.getElementById('create-update').style.display = "block"
                }

                function showUpdate(thisElem){
                    var rowElement = r.parentNode.parentNode;
                    personid = rowElement.getAttribute("id");

                    document.getElementById("idInput").value = personid
                    document.getElementById("idInput").disabled = true

                    document.getElementById('display').style.display = "none"
                    document.getElementById('update-button').style.display = "block"
                    document.getElementById('create-button').style.display = "none"
                    document.getElementById('create-update').style.display ="block"

                }
                function doCreate(){
                    console.log("indo create")
                    person = getPersonFromForm()
                    console.log(person)
                    $.ajax({
                        url:"/person",
                        data:JSON.stringify(person),
                        method:"POST",
                        dataType:"JSON",
                        contentType:"application/json; charset=utf-8",
                        success:function(result){
                            console.log(result)
                            addPersonToTable(person)
                            showDisplay()
                        },
                        error:function(hxr,status,error){
                            console.log("error"+error)
                        }
                    })
                    
                }
                function doDelete(r){
                    var tableElement = document.getElementById('personTable');
                    var rowElement = r.parentNode.parentNode;
                    var index = rowElement.rowIndex;
                    personid = rowElement.getAttribute("id");
                    $.ajax({
                        url:"/person/"+personid,
                        //date:JSON.stringify(person),
                        method:"DELETE",
                        dataType:"JSON",
                        //contentType:"application/json; charset=utf-8",
                        success:function(result){
                              tableElement.deleteRow(index);
                        },
                        error:function(xhr,status,error){
                            console.log(error)
                        }
                    })
                }

                function getPersonFromForm(){
                    var form = document.getElementById('createUpdateForm')
                    var person = {}
                    person.personid = form.querySelector('input[name="personid"]').value
                    person.personname = form.querySelector('input[name="personname"]').value
                    person.personage = form.querySelector('input[name="age"]').value
                    //console.log(person)
                    return person
                }


                function showDisplay(){
                    document.getElementById('display').style.display="block"
                    document.getElementById('create-update').style.display="none"
                }
                function populateTable(){
                         //ajax getAll
                    $.ajax({
                        url:"http://127.0.0.1:5000/person",
                        method:"GET",
                        datatype:"JSON",
                        success:function(results){
                            for (person of results){
                                addPersonToTable(person)
                            }
                        },
                        error:function(xhr,status,error){
                            console.log("error "+error+" code:"+status)
                        }
                    })
                }
                function addPersonToTable(person){
                       //console.log("Working so far")
                    tableElem = document.getElementById("personTable")
                    rowElem = tableElem.insertRow(-1)
                    rowElem.setAttribute("id", person.personid)
                    cell1 = rowElem.insertCell(0)
                    cell1.innerHTML = person.personid
                    cell2 = rowElem.insertCell(1)
                    cell2.innerHTML = person.personname
                    cell3 = rowElem.insertCell(2)
                    cell3.innerHTML = person.age
                    cell4 = rowElem.insertCell(3)
                    cell4.innerHTML ='<button onclick="showUpdate(this)">Update</button>'
                    cell5 = rowElem.insertCell(4)
                    cell5.innerHTML = '<button onclick="doDelete(this)">delete</button>'
                }   
                populateTable()
            </script>
    
    </body>
</html>